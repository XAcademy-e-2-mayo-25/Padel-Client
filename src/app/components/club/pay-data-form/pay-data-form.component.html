<div class="container py-3 paydata-container">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h2 class="mb-0">Métodos de cobro</h2>
      <small class="text-muted">Cargá métodos para que los jugadores puedan pagar reservas</small>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-secondary btn-sm" (click)="loadList()" [disabled]="loading">
        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
        Refrescar
      </button>

      <button class="btn btn-outline-secondary btn-sm" (click)="resetForm()">
        Limpiar
      </button>

      <button class="btn btn-outline-secondary btn-sm" (click)="goBack()">
        Volver
      </button>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
  <div *ngIf="feedback" class="alert alert-success">{{ feedback }}</div>

  <div class="row g-3">
    <!-- Form -->
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header">
          <strong>Crear método</strong>
        </div>

        <div class="card-body">
          <form [formGroup]="form" (ngSubmit)="submit()">
            <!-- metodoPago (input libre) -->
            <div class="mb-3">
              <label class="form-label">Método (visible para el jugador)</label>
              <input
                type="text"
                class="form-control"
                formControlName="metodoPago"
                placeholder="Ej: Transferencia Bancaria / Mercado Pago / Efectivo..."
                maxlength="80"
                (input)="onTextMaxLenInput('metodoPago', 80)"
              />
              <div class="hint">Máximo 80 caracteres.</div>
              <div class="text-danger small" *ngIf="ctrlInvalid('metodoPago')">
                El método es obligatorio y no puede superar 80 caracteres.
              </div>
            </div>

            <!-- CBU -->
            <div class="mb-3">
              <label class="form-label">CBU (22 dígitos)</label>
              <input
                type="text"
                class="form-control"
                formControlName="cbu"
                inputmode="numeric"
                autocomplete="off"
                maxlength="22"
                placeholder="Solo números (22)"
                (input)="onDigitsOnlyInput('cbu', 22)"
              />

              <div class="text-danger small" *ngIf="groupHas('cbuCvuBoth')">
                No podés cargar CBU y CVU a la vez (solo uno).
              </div>
              <div class="text-danger small" *ngIf="groupHas('cbuInvalidLen')">
                CBU inválido: debe tener 22 dígitos.
              </div>
            </div>

            <!-- CVU -->
            <div class="mb-3">
              <label class="form-label">CVU (22 dígitos)</label>
              <input
                type="text"
                class="form-control"
                formControlName="cvu"
                inputmode="numeric"
                autocomplete="off"
                maxlength="22"
                placeholder="Solo números (22)"
                (input)="onDigitsOnlyInput('cvu', 22)"
              />

              <div class="text-danger small" *ngIf="groupHas('cbuCvuBoth')">
                No podés cargar CBU y CVU a la vez (solo uno).
              </div>
              <div class="text-danger small" *ngIf="groupHas('cvuInvalidLen')">
                CVU inválido: debe tener 22 dígitos.
              </div>
            </div>

            <div class="text-danger small mb-3" *ngIf="groupHas('cbuCvuRequired')">
              Debés cargar CBU o CVU (al menos uno).
            </div>

            <!-- Alias -->
            <div class="mb-3">
              <label class="form-label">Alias</label>
              <input
                type="text"
                class="form-control"
                formControlName="alias"
                maxlength="60"
                placeholder="Alias (opcional)"
                (input)="onTextMaxLenInput('alias', 60)"
              />
              <div class="hint">Máximo 60 caracteres.</div>
            </div>

            <!-- Titular (debajo de alias, mismo ancho) -->
            <div class="mb-3">
              <label class="form-label">Titular</label>
              <input
                type="text"
                class="form-control"
                formControlName="titular"
                maxlength="150"
                placeholder="Nombre del titular (opcional)"
                (input)="onTextMaxLenInput('titular', 150)"
              />
            </div>

            <!-- DNI/CUIT/CUIL (debajo de titular, solo números) -->
            <div class="mb-3">
              <label class="form-label">DNI / CUIT / CUIL</label>
              <input
                type="text"
                class="form-control"
                formControlName="dniCuitCuil"
                inputmode="numeric"
                autocomplete="off"
                maxlength="20"
                placeholder="Solo números (opcional)"
                (input)="onDigitsOnlyInput('dniCuitCuil', 20)"
              />
              <div class="hint">Solo números. Máximo 20.</div>
            </div>

            <!-- Banco -->
            <div class="mb-3">
              <label class="form-label">Banco</label>
              <input
                type="text"
                class="form-control"
                formControlName="banco"
                maxlength="80"
                placeholder="Banco (opcional)"
                (input)="onTextMaxLenInput('banco', 80)"
              />
            </div>

            <!-- Tipo cuenta -->
            <div class="mb-3">
              <label class="form-label">Tipo de cuenta</label>
              <input
                type="text"
                class="form-control"
                formControlName="tipoCuenta"
                maxlength="50"
                placeholder="Ej: Caja de ahorro (opcional)"
                (input)="onTextMaxLenInput('tipoCuenta', 50)"
              />
            </div>

            <!-- Número cuenta -->
            <div class="mb-3">
              <label class="form-label">Número de cuenta</label>
              <input
                type="text"
                class="form-control"
                formControlName="numeroCuenta"
                maxlength="30"
                placeholder="Número de cuenta (opcional)"
                (input)="onTextMaxLenInput('numeroCuenta', 30)"
              />
            </div>

            <!-- Activo -->
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="activoSwitch" formControlName="activo" />
              <label class="form-check-label" for="activoSwitch">Activo</label>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-primary" type="submit" [disabled]="saving">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                Guardar
              </button>
              <button class="btn btn-outline-secondary" type="button" (click)="resetForm()">
                Limpiar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Listado -->
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Existentes</strong>
          <span class="badge bg-secondary">{{ items.length }}</span>
        </div>

        <div class="card-body">
          <div *ngIf="loading" class="text-muted">Cargando...</div>
          <div *ngIf="!loading && items.length === 0" class="text-muted">
            No hay métodos de cobro cargados.
          </div>

          <div class="list-group" *ngIf="!loading && items.length > 0">
            <button
              type="button"
              class="list-group-item list-group-item-action"
              *ngFor="let it of items"
              (click)="selectItem(it)"
              [class.active]="selected?.idDatosPago === it.idDatosPago"
            >
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">{{ it.metodoPago }}</div>
                  <div class="small opacity-75">
                    {{ it.activo ? 'Activo' : 'Inactivo' }}
                    · {{ it.cbu ? 'CBU' : (it.cvu ? 'CVU' : '---') }}
                  </div>
                </div>
                <span class="badge" [class.bg-success]="it.activo" [class.bg-secondary]="!it.activo">
                  #{{ it.idDatosPago }}
                </span>
              </div>
            </button>
          </div>

          <div class="mt-3" *ngIf="selected as s">
            <div class="card details-card">
              <div class="card-header">
                <strong>Detalle</strong>
              </div>
              <div class="card-body">
                <div><strong>Método:</strong> {{ s.metodoPago }}</div>
                <div><strong>CBU:</strong> {{ s.cbu || '-' }}</div>
                <div><strong>CVU:</strong> {{ s.cvu || '-' }}</div>
                <div><strong>Alias:</strong> {{ s.alias || '-' }}</div>
                <div><strong>Titular:</strong> {{ s.titular || '-' }}</div>
                <div><strong>DNI/CUIT/CUIL:</strong> {{ s.dniCuitCuil || '-' }}</div>
                <div><strong>Banco:</strong> {{ s.banco || '-' }}</div>
                <div><strong>Tipo cuenta:</strong> {{ s.tipoCuenta || '-' }}</div>
                <div><strong>Número cuenta:</strong> {{ s.numeroCuenta || '-' }}</div>
                <div><strong>Activo:</strong> {{ s.activo ? 'Sí' : 'No' }}</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
