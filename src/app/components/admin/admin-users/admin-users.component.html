<div class="container py-3 users-container">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <div>
      <h1 class="fw-bold mb-1">Usuarios</h1>
      <p class="text-muted mb-0">Listado de usuarios con sus roles. Filtrá y ordená para gestionar.</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Volver al panel
      </button>
      <button class="btn btn-danger btn-sm" (click)="logout()">
        <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
      </button>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Nombre o apellido</label>
          <input type="text" class="form-control" [(ngModel)]="filters.nombre" placeholder="Ej: Juan Pérez">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Email</label>
          <input type="text" class="form-control" [(ngModel)]="filters.email" placeholder="mail@ejemplo.com">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Rol</label>
          <select class="form-select" [(ngModel)]="filters.idRol">
            <option value="">Todos</option>
            <option [value]="1">Administrador</option>
            <option [value]="2">Jugador</option>
            <option [value]="3">Club</option>
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Ordenar por</label>
          <select class="form-select" [(ngModel)]="filters.sortBy">
            <option value="idUsuario">ID</option>
            <option value="nombres">Nombre</option>
            <option value="apellidos">Apellido</option>
            <option value="email">Email</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Dirección</label>
          <select class="form-select" [(ngModel)]="filters.sortDir">
            <option value="ASC">Ascendente</option>
            <option value="DESC">Descendente</option>
          </select>
        </div>
        <div class="col-12 col-md-4 d-flex align-items-end gap-2">
          <button class="btn btn-primary w-100" (click)="loadUsers()" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-1"></span>
            Buscar
          </button>
          <button class="btn btn-outline-secondary" (click)="resetFilters()" [disabled]="loading">Limpiar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card pending-card">
    <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
      <div>
        <h5 class="mb-1">Usuarios</h5>
        <small class="text-muted">Total: {{ users.length }}</small>
      </div>
    </div>
    <div class="card-body">
      <div *ngIf="loading" class="text-center text-muted py-3">
        Cargando usuarios...
      </div>

      <div *ngIf="error" class="alert alert-danger py-2">
        {{ error }}
      </div>

      <div *ngIf="message" class="alert alert-success py-2">
        {{ message }}
      </div>

      <div *ngIf="!loading && users.length === 0 && !error" class="text-muted text-center py-3">
        No hay usuarios para mostrar.
      </div>

      <div class="table-responsive" *ngIf="users.length > 0">
        <table class="table table-hover pending-table align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Roles</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users">
              <td>#{{ user.idUsuario }}</td>
              <td>
                <div class="fw-semibold">{{ user.nombres }} {{ user.apellidos }}</div>
              </td>
              <td>{{ user.email }}</td>
              <td>
                <div class="d-flex flex-wrap gap-1 align-items-center">
                  <ng-container *ngFor="let ur of (user.usuarioRoles || [])">
                    <span [class]="roleBadgeClass(ur.idRol)">
                      {{ roleName(ur.idRol) }}
                    </span>
                    <span class="ms-1" [class]="roleEstadoClass(ur.idEstado)">
                      {{ roleEstadoLabel(ur.idEstado) }}
                    </span>
                  </ng-container>
                  <span *ngIf="!user.usuarioRoles || user.usuarioRoles.length === 0" class="badge bg-secondary">Sin roles</span>
                </div>
              </td>

              <td>
                <ng-container *ngIf="hasPlayerRole(user); else noActions">

                  <!-- Si está habilitado muestra el boton BANEAR -->
                  <button
                    *ngIf="isPlayerEnabled(user)"
                    class="btn btn-outline-danger btn-sm w-100 mb-1"
                    [disabled]="actingUserId === user.idUsuario"
                    (click)="openBanModal(user)"
                  >
                    <span *ngIf="actingUserId === user.idUsuario && actingState === 3" class="spinner-border spinner-border-sm me-1"></span>
                    Banear jugador
                  </button>

                  <!-- Si está baneado muestra el boton HABILITAR -->
                  <button
                    *ngIf="isPlayerBanned(user)"
                    class="btn btn-outline-success btn-sm w-100 mb-1"
                    [disabled]="actingUserId === user.idUsuario"
                    (click)="habilitarJugador(user)"
                  >
                    <span *ngIf="actingUserId === user.idUsuario && actingState === 2" class="spinner-border spinner-border-sm me-1"></span>
                    Habilitar jugador
                  </button>

                  <!-- si es pendiente no mostramos acción -->
                  <span *ngIf="!isPlayerEnabled(user) && !isPlayerBanned(user)" class="text-muted small">
                    Sin acción disponible
                  </span>

                </ng-container>

                <ng-template #noActions>
                  <span class="text-muted small">Sin rol jugador</span>
                </ng-template>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAY PARA BAN MODAL -->
<div class="overlay" *ngIf="banModalOpen" (click)="$event.stopPropagation()">
  <div class="overlay-card card" (click)="$event.stopPropagation()">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">Banear jugador</h5>
        <small class="text-muted">
          {{ banTargetUser?.nombres }} {{ banTargetUser?.apellidos }} (#{{ banTargetUser?.idUsuario }})
        </small>
      </div>
      <button class="btn btn-outline-secondary btn-sm" (click)="closeBanModal()" [disabled]="actingUserId !== null">
        Cerrar
      </button>
    </div>

    <div class="card-body">
      <div class="mb-2 text-muted small">
        Motivo del ban.
      </div>

      <div class="mb-3">
        <label class="form-label small fw-bold text-secondary">Motivo</label>
        <textarea
          class="form-control"
          rows="3"
          [(ngModel)]="banMotivo"
          placeholder="Ej: Incumplimiento de normas, denuncias, etc."
          [disabled]="actingUserId !== null"
        ></textarea>
      </div>

      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-outline-secondary btn-sm" (click)="closeBanModal()" [disabled]="actingUserId !== null">
          Cancelar
        </button>

        <button
          class="btn btn-danger btn-sm"
          (click)="confirmarBanJugador()"
          [disabled]="!banMotivo.trim() || actingUserId !== null"
        >
          <span *ngIf="actingUserId !== null && actingState === 3" class="spinner-border spinner-border-sm me-2"></span>
          Confirmar ban
        </button>
      </div>
    </div>
  </div>
</div>
